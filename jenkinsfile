pipeline {
    agent any

    environment {
        AWS_REGION = 'us-west-1'
        DYNAMIC_ENVIRONMENT_NAME = "review-${env.BRANCH_NAME}"
        DYNAMIC_ENVIRONMENT_URL = "https://${env.JOB_NAME}-${env.BUILD_NUMBER}.${env.DYNAMIC_ENVIRONMENT_NAME}.your-domain.com"
        SONAR_URL = 'http://13.52.68.80:9000' // Replace with actual SonarQube IP
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Debug AWS Credentials') {
            steps {
                script {
                    sh 'echo $AWS_REGION'
                    sh 'echo $AWS_ACCESS_KEY_ID'  // Confirm these are set, but avoid printing secret keys
                }
            }
        }

        stage('Validate Terraform') {
            steps {
                script {
                    withCredentials([aws(credentialsId: 'teelake-aws', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        dir('terraform/eks-cluster-ec2') {
                            sh 'terraform init'
                            sh 'TF_LOG=DEBUG terraform validate'
                        }
                    }
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                script {
                    withCredentials([aws(credentialsId: 'teelake-aws', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        dir('terraform/eks-cluster-ec2') {
                            sh 'terraform plan -out=tfplan'
                        }
                    }
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'terraform/eks-cluster-ec2/tfplan', allowEmptyArchive: true
                }
            }
        }

        stage('Terraform Apply') {
            when {
                branch 'master'
            }
            steps {
                script {
                    withCredentials([aws(credentialsId: 'teelake-aws', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        dir('terraform/eks-cluster-ec2') {
                            sh 'terraform apply -auto-approve tfplan'
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh 'docker build -t kaledros-python-app:$BUILD_NUMBER .'
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    sh 'docker run kaledros-python-app:$BUILD_NUMBER python kaledros-script.py --test'
                }
            }
        }

        stage('Deploy to Kubernetes') {
            when {
                branch 'master'
            }
            steps {
                script {
                    withCredentials([string(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
                        sh '''
                            kubectl config set-context --current --namespace=default
                            helm upgrade --install my-release ./helm-chart \
                                --set image.tag=$BUILD_NUMBER \
                                --set environment.name=$DYNAMIC_ENVIRONMENT_NAME \
                                --set environment.url=$DYNAMIC_ENVIRONMENT_URL
                        '''
                    }
                }
            }
        }

        // New Stage for DevSecOps Deployment
        stage('Deploy DevSecOps Project') {
            steps {
                script {
                    // Clone DevSecOps repository and build/run it
                    sh '''
                        git clone https://github.com/N4si/DevSecOps-Project.git
                        cd DevSecOps-Project
                        docker build -t devsecops-app .
                        docker run -d -p 3000:3000 devsecops-app  # Adjust port as necessary
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
